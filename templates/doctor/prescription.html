{% extends "base.html" %}

{% block title %}Prescriptions{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Prescriptions</h2>
                <div>
                    <button class="btn btn-primary" data-toggle="modal" data-target="#addPrescriptionModal">
                        <i class="fas fa-plus"></i> New Prescription
                    </button>
                    <a href="{{ url_for('doctor.dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
            
            <!-- Prescription Statistics -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Total Prescriptions</h5>
                            <h3 class="text-primary">{{ prescriptions|length }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">This Week</h5>
                            <h3 class="text-info">{{ prescriptions|selectattr('date', 'greaterthan', week_ago)|list|length }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Active</h5>
                            <h3 class="text-success">{{ prescriptions|selectattr('status', 'equalto', 'Active')|list|length }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Prescriptions Table -->
            {% if prescriptions %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Prescription ID</th>
                            <th>Patient</th>
                            <th>Medication</th>
                            <th>Instructions</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for prescription in prescriptions %}
                        <tr>
                            <td>#{{ prescription.script_id }}</td>
                            <td>
                                {% if prescription.patient %}
                                    {{ prescription.patient.name }}
                                {% else %}
                                    Patient #{{ prescription.patient_id }}
                                {% endif %}
                            </td>
                            <td>
                                {% if prescription.medications %}
                                    {% for med in prescription.medications %}
                                        {{ med.medication.name }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>{{ prescription.instructions[:50] }}{% if prescription.instructions|length > 50 %}...{% endif %}</td>
                            <td>{{ prescription.date.strftime('%Y-%m-%d') if prescription.date else 'N/A' }}</td>
                            <td>
                                <span class="badge badge-{{ 
                                    'success' if prescription.status == 'Active' 
                                    else 'secondary' if prescription.status == 'Completed'
                                    else 'warning' }}">
                                    {{ prescription.status }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info view-btn" data-prescription-id="{{ prescription.script_id }}">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-warning edit-btn" data-prescription-id="{{ prescription.script_id }}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                No prescriptions found. Create your first prescription using the "New Prescription" button.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Prescription Modal -->
<div class="modal fade" id="addPrescriptionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Prescription</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="POST" action="{{ url_for('doctor.new_prescription') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="patient_id">Patient:</label>
                                <select name="patient_id" id="patient_id" class="form-control" required>
                                    <option value="">Select Patient</option>
                                    {% for patient in patients %}
                                    <option value="{{ patient.patient_id }}">{{ patient.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="date">Date:</label>
                                <input type="date" name="date" id="date" class="form-control" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="instructions">Instructions:</label>
                        <textarea name="instructions" id="instructions" class="form-control" rows="4" 
                                  placeholder="Enter dosage instructions, frequency, duration, etc." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="medications">Medications:</label>
                        <textarea name="medications" id="medications" class="form-control" rows="3" 
                                  placeholder="List medications, one per line"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Prescription</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Prescription Modal -->
<div class="modal fade" id="viewPrescriptionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Prescription Details</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="prescriptionDetails">
                    <!-- Prescription details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    const dateInput = document.getElementById('date');
    if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
    
    // Add event listeners for view buttons
    document.querySelectorAll('.view-btn').forEach(button => {
        button.addEventListener('click', function() {
            viewPrescription(this.getAttribute('data-prescription-id'));
        });
    });
    
    // Add event listeners for edit buttons
    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function() {
            editPrescription(this.getAttribute('data-prescription-id'));
        });
    });
});

function viewPrescription(prescriptionId) {
    // Load prescription details via AJAX or redirect
    window.location.href = `/doctor/prescriptions/${prescriptionId}`;
}

function editPrescription(prescriptionId) {
    // Redirect to edit page
    window.location.href = `/doctor/prescriptions/${prescriptionId}/edit`;
}
</script>
{% endblock %}