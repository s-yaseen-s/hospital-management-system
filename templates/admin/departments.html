{% extends "base.html" %}

{% block title %}Department Management{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Department Management</h1>
    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-primary">Back to Dashboard</a>
</div>

<div class="dashboard-stats">
    <div class="stat-card">
        <h3>Total Departments</h3>
        <div class="number">{{ departments|length }}</div>
    </div>
    <div class="stat-card">
        <h3>Active Departments</h3>
        <div class="number">{{ departments|selectattr('status', 'equalto', 'Active')|list|length }}</div>
    </div>
    <div class="stat-card">
        <h3>Total Doctors</h3>
        <div class="number">{{ departments|sum(attribute='doctors_count') if departments else 0 }}</div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>All Departments</h2>
        <button class="btn btn-success" data-toggle="modal" data-target="#addDepartmentModal">
            <i class="fas fa-plus"></i> Add Department
        </button>
    </div>

    {% if departments %}
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Department ID</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Head Doctor</th>
                    <th>Doctors Count</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for dept in departments %}
                <tr>
                    <td>{{ dept.dept_id }}</td>
                    <td>
                        <strong>{{ dept.name }}</strong>
                    </td>
                    <td>{{ dept.description[:100] }}{% if dept.description|length > 100 %}...{% endif %}</td>
                    <td>
                        {% if dept.head_doctor %}
                            Dr. {{ dept.head_doctor.name }}
                        {% else %}
                            <span class="text-muted">Not Assigned</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge badge-primary">{{ dept.doctors_count or 0 }}</span>
                    </td>
                    <td>
                        <span class="badge badge-{{ 
                            'success' if dept.status == 'Active' 
                            else 'secondary' if dept.status == 'Inactive'
                            else 'warning' }}">
                            {{ dept.status }}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info view-btn" data-department-id="{{ dept.dept_id }}">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-sm btn-warning edit-btn" data-department-id="{{ dept.dept_id }}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        {% if dept.status == 'Active' %}
                        <form method="POST" action="{{ url_for('admin.toggle_department_status', dept_id=dept.dept_id) }}" style="display: inline;">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to deactivate this department?')">Deactivate</button>
                        </form>
                        {% else %}
                        <form method="POST" action="{{ url_for('admin.toggle_department_status', dept_id=dept.dept_id) }}" style="display: inline;">
                            <button type="submit" class="btn btn-sm btn-success">Activate</button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>
{% endblock %}